<!DOCTYPE html>
<html>
    <head>
        <title>Sources</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
        <link rel="shortcut icon" href="#">
    </head>
    <body>
        <h1>Sources and Keywords</h1>
        <div><button id="button-showAddSource" onclick="showAddSource()">Add News Source</button><br/><br/></div>
        <div>
            <table border="1" id="sourceTable">
                <tr>
                        <th>id</th>
                        <th>Source</th>
                        <th>Keyword</th>
                        <th>Update</th>
                        <th>Delete</th>
                </tr>  
            
            </table>
        <br/>
        </div>
        <div>
            <form id="createForm" style="display:none">
                <h2><span id="createLabel">Create a Source</span></h2>
                Source <input type="text" name="source"><br/>
                Keyword <input type="text" name="keyword"><br/>
            
                <span><button type="submit" id="button-doAddSource">Create</button></span>

            </form>
        </div>
        <div>
            <form id="updateForm" style="display:none">
                <h2><span id="updateLabel">Update this Source</span></h2>
                Source <input type="text" name="source"><br/>
                Keyword <input type="text" name="keyword"><br/>
        
                <span><button type="submit" id="button-doUpdateSource">Update</button></span>

            </form>
        </div>
    </body>
    <script>
        //Using fetch to populate table with MySQL database table content
        // https://dev.to/duhbhavesh/how-to-use-fetch-api-for-crud-operations-57a0
        fetch('/sourcesjson')
        .then(response => response.json())
        .then(data => {
            // Loop through the data and add a row for each item
            data.forEach(item => {
            let row = document.createElement('tr');
            row.innerHTML = `
            <td>${item.id}</td>
            <td>${item.source}</td>
            <td>${item.keyword}</td>
            <td><button class="update-button" data-id="${item.id}" onclick="showUpdateSource(this)">Update</button></td>
            <td><button class="delete-button" data-id="${item.id}" onclick="deleteSource(event)">Delete</button></td>`;
            document.querySelector('#sourceTable').appendChild(row);
            });
        });

        function showAddSource(){
            document.getElementById("createForm").style.display = "block"  
            document.getElementById("button-doAddSource").style.display = "block"
            document.getElementById("createLabel").style.display = "inline"
            document.getElementById("button-showAddSource").style.display = "none"
            document.getElementById("sourceTable").style.display = "none"  
        }

        // Adding sources input by the user to the table
        var createForm = document.getElementById('createForm');
        createForm.addEventListener('submit', function(event) {
            // https://stackoverflow.com/a/56908493
            event.preventDefault();
            // Use the fetch API to send the form data to the server
            fetch('/sources', {
                method: 'POST',
                body: new FormData(createForm)
            })
            .then(response => response.text())
            .then(text => {
                console.log(text);
                location.reload();
            })
        });

        // Deleting source from the table
        function deleteSource(event) {
            event.preventDefault();
            var id = event.target.getAttribute('data-id');
            fetch('/sources/' + id, {
                method: 'DELETE'
            })
            .then(response => response.text())
            .then(text => {
                console.log(text);
                location.reload();
            })
        }

        // Updating source in table
        function getSourceFromRow(rowElement){
            var source ={}
            source.id  = rowElement.cells[0].firstChild.textContent
            source.source = rowElement.cells[1].firstChild.textContent
            source.keyword = rowElement.cells[2].firstChild.textContent
            return source
        }
        function populateFormWithSource(source){
       		var form = document.getElementById('updateForm')
       		form.querySelector('input[name="source"]').value= source.source
        	form.querySelector('input[name="keyword"]').value= source.keyword
        }
        function showUpdateSource(buttonElement){
            document.getElementById("updateForm").style.display = "block"           
            document.getElementById("button-doUpdateSource").style.display = "block"
            document.getElementById("updateLabel").style.display = "inline"
            document.getElementById("sourceTable").style.display = "none"
            rowElement= buttonElement.parentNode.parentNode
            source = getSourceFromRow(rowElement)
            populateFormWithSource(source)
            
            var updateForm = document.getElementById('updateForm');
            updateForm.addEventListener('submit', function(event) {
                id = source['id'];
                console.log(id)
                // https://stackoverflow.com/a/56908493
                event.preventDefault();
                // Use the fetch API to send the form data to the server
                fetch('/sources/' + id, {
                    method: 'PUT',
                    body: new FormData(updateForm)
                })
                .then(response => response.text())
                .then(text => {
                    console.log(text);
                    location.reload();
                })
        });

        }
        
            


    </script>
</html>